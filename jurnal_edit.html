<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Penjurnalan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header .icon {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            padding: 10px;
            border-radius: 10px;
            font-size: 1.5rem;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .form-container, .data-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .form-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            font-size: 1.3rem;
            color: #333;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4ecdc4 0%, #2ecc71 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%);
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .data-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .data-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            color: #333;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #555;
            margin: 0;
        }
        
        .filter-group select {
            min-width: 150px;
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        
        th.sortable::after {
            content: ' ↕️';
            font-size: 12px;
        }
        
        th.sort-asc::after {
            content: ' ⬆️';
            font-size: 12px;
        }
        
        th.sort-desc::after {
            content: ' ⬇️';
            font-size: 12px;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-hadir { background: #d4edda; color: #155724; }
        .status-tidak-hadir { background: #f8d7da; color: #721c24; }
        .status-sakit { background: #fff3cd; color: #856404; }
        .status-izin { background: #cce7ff; color: #004085; }
        .status-selesai { background: #d4edda; color: #155724; }
        .status-tidak-selesai { background: #f8d7da; color: #721c24; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .summary-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .data-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-buttons {
                justify-content: center;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                justify-content: space-between;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>
                <span class="icon">📚</span>
                Aplikasi Penjurnalan
            </h1>
            <p>Sistem pencatatan kegiatan pembelajaran</p>
			<p>SD Negeri 40 Kecamatan Pontianak Utara</p>
        </header>

        <div class="form-container">
            <div class="form-title">
                <span>✏️</span>
                Tambah Data Jurnal
            </div>
            
            <form id="journalForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tanggal">Tanggal</label>
                        <input type="date" id="tanggal" name="tanggal" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="kelas">Kelas</label>
                        <select id="kelas" name="kelas" required>
                            <option value="">Pilih Kelas</option>
                            <option value="1">KELAS 1</option>
                            <option value="2 A">KELAS 2 A</option>
                            <option value="2 B">KELAS 2 B</option>
                            <option value="3 A">KELAS 3 A</option>
                            <option value="3 B">KELAS 3 B</option>
                            <option value="4 A">KELAS 4 A</option>
                            <option value="4 B">KELAS 4 B</option>
                            <option value="5 A">KELAS 5 A</option>
                            <option value="5 B">KELAS 5 B</option>
                            <option value="6 A">KELAS 6 A</option>
                            <option value="6 B">KELAS 6 B</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="jam_mulai">Jam Mulai</label>
                        <input type="time" id="jam_mulai" name="jam_mulai" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="jam_selesai">Jam Selesai</label>
                        <input type="time" id="jam_selesai" name="jam_selesai" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="materi">Materi</label>
                        <textarea id="materi" name="materi" placeholder="Masukkan materi pembelajaran" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status" required>
                            <option value="">Pilih Status</option>
                            <option value="Selesai">Selesai</option>
                            <option value="Tidak Selesai">Tidak Selesai</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="tidak_hadir">Tidak Hadir</label>
                        <input type="text" id="tidak_hadir" name="tidak_hadir" placeholder="Nama siswa yang tidak hadir">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="catatan">Catatan</label>
                        <textarea id="catatan" name="catatan" placeholder="Catatan tambahan..."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span>💾</span>
                    Simpan Data
                </button>
            </form>
        </div>

        <div class="data-container">
            <div class="data-controls">
                <div class="data-title">
                    <span>📊</span>
                    Data Penjurnalan
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="loadData()">
                        <span>🔄</span>
                        Muat Ulang
                    </button>
                    <button class="btn btn-warning" onclick="downloadExcel()">
                        <span>📊</span>
                        Download Excel
                    </button>
                    <button class="btn btn-success" onclick="downloadCSV()">
                        <span>📥</span>
                        Download CSV
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllData()">
                        <span>🗑️</span>
                        Hapus Semua
                    </button>
                </div>
            </div>
            
            <div class="summary-cards" id="summaryCards" style="display: none;">
                <div class="summary-card">
                    <h3 id="totalEntries">0</h3>
                    <p>Total Jurnal</p>
                </div>
                <div class="summary-card">
                    <h3 id="totalClasses">0</h3>
                    <p>Total Kelas</p>
                </div>
                <div class="summary-card">
                    <h3 id="completedLessons">0</h3>
                    <p>Selesai</p>
                </div>
                <div class="summary-card">
                    <h3 id="incompleteLessons">0</h3>
                    <p>Tidak Selesai</p>
                </div>
            </div>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filterKelas">Filter Kelas:</label>
                    <select id="filterKelas" onchange="filterData()">
                        <option value="">Semua Kelas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortBy">Urutkan:</label>
                    <select id="sortBy" onchange="sortData()">
                        <option value="tanggal">Tanggal</option>
                        <option value="jam_mulai">Jam Mulai</option>
                        <option value="jam_selesai">Jam Selesai</option>
                        <option value="kelas">Kelas</option>
                        <option value="status">Status</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortOrder">Urutan:</label>
                    <select id="sortOrder" onchange="sortData()">
                        <option value="asc">A-Z / Terlama</option>
                        <option value="desc">Z-A / Terbaru</option>
                    </select>
                </div>
            </div>
            
            <div id="alertContainer"></div>
            
            <div class="table-container">
                <div id="loadingContainer" class="loading">
                    <div class="spinner"></div>
                    <p>Memuat data dari Google Sheets...</p>
                </div>
                
                <table id="dataTable" style="display: none;">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="tanggal">Tanggal</th>
                            <th class="sortable" data-column="kelas">Kelas</th>
                            <th class="sortable" data-column="jam_mulai">Jam Mulai</th>
                            <th class="sortable" data-column="jam_selesai">Jam Selesai</th>
                            <th class="sortable" data-column="materi">Materi</th>
                            <th class="sortable" data-column="status">Status</th>
                            <th>Tidak Hadir</th>
                            <th>Catatan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                    </tbody>
                </table>
                
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="icon">📋</div>
                    <h3>Belum ada data</h3>
                    <p>Mulai tambahkan data jurnal pembelajaran Anda</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz2z8vDhCHc5Bmz9JhgEBhnIy4n20DqhEPIbnyq5u7fmyXNx25W_eCMmTpA85yIx8inPQ/exec';
        
        let currentData = [];
        let filteredData = [];
        let currentSort = { column: 'tanggal', order: 'desc' };

        // Set tanggal hari ini sebagai default
        document.getElementById('tanggal').valueAsDate = new Date();

        // Event listener untuk form submit
        document.getElementById('journalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await addData();
        });

        // Event listener untuk sorting pada header tabel
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('th.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.getAttribute('data-column');
                    if (currentSort.column === column) {
                        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.order = 'asc';
                    }
                    updateSortHeaders();
                    renderTable();
                });
            });
            
            loadData();
        });

        // Fungsi untuk menambah data
        async function addData() {
            const form = document.getElementById('journalForm');
            const formData = new FormData(form);
            
            const data = {
                action: 'add',
                tanggal: formData.get('tanggal'),
                kelas: formData.get('kelas'),
                jam_mulai: formData.get('jam_mulai'),
                jam_selesai: formData.get('jam_selesai'),
                materi: formData.get('materi'),
                status: formData.get('status'),
                tidak_hadir: formData.get('tidak_hadir') || '',
                catatan: formData.get('catatan') || ''
            };
            
            try {
                showAlert('Menyimpan data...', 'success');
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(data).toString()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Data berhasil ditambahkan!', 'success');
                    form.reset();
                    document.getElementById('tanggal').valueAsDate = new Date();
                    await loadData();
                } else {
                    showAlert('Gagal menambahkan data: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Terjadi kesalahan saat menyimpan data', 'error');
            }
        }

        // Fungsi untuk memuat data
        async function loadData() {
            const loadingContainer = document.getElementById('loadingContainer');
            const dataTable = document.getElementById('dataTable');
            const emptyState = document.getElementById('emptyState');
            const summaryCards = document.getElementById('summaryCards');
            
            loadingContainer.style.display = 'block';
            dataTable.style.display = 'none';
            emptyState.style.display = 'none';
            summaryCards.style.display = 'none';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=get`);
                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data || [];
                    
                    if (currentData.length === 0) {
                        loadingContainer.style.display = 'none';
                        emptyState.style.display = 'block';
                        return;
                    }
                    
                    // Remove header row and process data
                    const dataRows = currentData.slice(1);
                    filteredData = dataRows.map((row, index) => ({
                        originalIndex: index + 1,
                        tanggal: row[1] || '',
                        jam_mulai: row[2] || '',
                        jam_selesai: row[3] || '',
                        kelas: row[4] || '',
                        status: row[5] || '',
                        materi: row[6] || '',
                        tidak_hadir: row[7] || '',
                        catatan: row[8] || ''
                    }));
                    
                    updateFilterOptions();
                    updateSummary();
                    renderTable();
                    
                    loadingContainer.style.display = 'none';
                    dataTable.style.display = 'table';
                    summaryCards.style.display = 'grid';
                } else {
                    throw new Error(result.message || 'Gagal memuat data');
                }
            } catch (error) {
                console.error('Error:', error);
                loadingContainer.style.display = 'none';
                showAlert('Gagal memuat data: ' + error.message, 'error');
            }
        }

        // Fungsi untuk update opsi filter
        function updateFilterOptions() {
            const filterKelas = document.getElementById('filterKelas');
            const kelasSet = new Set();
            
            filteredData.forEach(item => {
                if (item.kelas) {
                    kelasSet.add(item.kelas);
                }
            });
            
            // Sort kelas options
            const sortedKelas = Array.from(kelasSet).sort((a, b) => {
                // Sort by numeric value first, then by letter
                const aNum = parseInt(a);
                const bNum = parseInt(b);
                if (aNum !== bNum) return aNum - bNum;
                return a.localeCompare(b);
            });
            
            filterKelas.innerHTML = '<option value="">Semua Kelas</option>';
            sortedKelas.forEach(kelas => {
                filterKelas.innerHTML += `<option value="${kelas}">${kelas}</option>`;
            });
        }

        // Fungsi untuk update ringkasan
        function updateSummary() {
            const totalEntries = filteredData.length;
            const uniqueClasses = new Set(filteredData.map(item => item.kelas)).size;
            const completedLessons = filteredData.filter(item => item.status === 'Selesai').length;
            const incompleteLessons = filteredData.filter(item => item.status === 'Tidak Selesai').length;
            
            document.getElementById('totalEntries').textContent = totalEntries;
            document.getElementById('totalClasses').textContent = uniqueClasses;
            document.getElementById('completedLessons').textContent = completedLessons;
            document.getElementById('incompleteLessons').textContent = incompleteLessons;
        }

        // Fungsi untuk filter data
        function filterData() {
            const filterKelas = document.getElementById('filterKelas').value;
            
            if (!filterKelas) {
                filteredData = currentData.slice(1).map((row, index) => ({
                    originalIndex: index + 1,
                    tanggal: row[1] || '',
                    jam_mulai: row[2] || '',
                    jam_selesai: row[3] || '',
                    kelas: row[4] || '',
                    status: row[5] || '',
                    materi: row[6] || '',
                    tidak_hadir: row[7] || '',
                    catatan: row[8] || ''
                }));
            } else {
                filteredData = currentData.slice(1).map((row, index) => ({
                    originalIndex: index + 1,
                    tanggal: row[1] || '',
                    jam_mulai: row[2] || '',
                    jam_selesai: row[3] || '',
                    kelas: row[4] || '',
                    status: row[5] || '',
                    materi: row[6] || '',
                    tidak_hadir: row[7] || '',
                    catatan: row[8] || ''
                })).filter(item => item.kelas === filterKelas);
            }
            
            updateSummary();
            renderTable();
        }

        // Fungsi untuk sorting data
        function sortData() {
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            currentSort = { column: sortBy, order: sortOrder };
            updateSortHeaders();
            renderTable();
        }

        // Fungsi untuk update header sorting
        function updateSortHeaders() {
            document.querySelectorAll('th.sortable').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                const column = header.getAttribute('data-column');
                if (column === currentSort.column) {
                    header.classList.add(currentSort.order === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // Fungsi untuk render tabel
        function renderTable() {
            const dataBody = document.getElementById('dataBody');
            const emptyState = document.getElementById('emptyState');
            const dataTable = document.getElementById('dataTable');
            
            if (filteredData.length === 0) {
                dataTable.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            // Sort data
            const sortedData = [...filteredData].sort((a, b) => {
                let aValue = a[currentSort.column];
                let bValue = b[currentSort.column];
                
                // Handle date sorting
                if (currentSort.column === 'tanggal') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                }
                
                // Handle jam_mulai sorting
                if (currentSort.column === 'jam_mulai') {
                    aValue = a.jam_mulai;
                    bValue = b.jam_mulai;
                }
                
                // Handle jam_selesai sorting
                if (currentSort.column === 'jam_selesai') {
                    aValue = a.jam_selesai;
                    bValue = b.jam_selesai;
                }
                
                if (aValue < bValue) return currentSort.order === 'asc' ? -1 : 1;
                if (aValue > bValue) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            
            dataBody.innerHTML = '';
            sortedData.forEach((item) => {
                const tr = document.createElement('tr');
                const waktu = item.jam_mulai && item.jam_selesai ? `${item.jam_mulai} - ${item.jam_selesai}` : '-';
                const statusClass = getStatusClass(item.status);
                
                tr.innerHTML = `
                    <td>${formatDate(item.tanggal)}</td>
                    <td>${item.kelas || '-'}</td>
                    <td>${formatTime(item.jam_mulai) || '-'}</td>
                    <td>${formatTime(item.jam_selesai) || '-'}</td>
                    <td>${item.materi || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${item.status || '-'}</span></td>
                    <td>${item.tidak_hadir || '-'}</td>
                    <td>${item.catatan || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRow(${item.originalIndex})">
                            <span>🗑️</span>
                            Hapus
                        </button>
                    </td>
                `;
                dataBody.appendChild(tr);
            });
            
            dataTable.style.display = 'table';
            emptyState.style.display = 'none';
        }

        // Fungsi untuk menghapus satu baris
        async function deleteRow(rowIndex) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;
            
            try {
                showAlert('Menghapus data...', 'success');
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'delete',
                        row: rowIndex + 1 // +1 because sheets are 1-indexed
                    }).toString()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Data berhasil dihapus!', 'success');
                    await loadData();
                } else {
                    showAlert('Gagal menghapus data: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Terjadi kesalahan saat menghapus data', 'error');
            }
        }

        // Fungsi untuk menghapus semua data
        async function deleteAllData() {
            if (!confirm('Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) return;
            
            try {
                showAlert('Menghapus semua data...', 'success');
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'deleteAll'
                    }).toString()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Semua data berhasil dihapus!', 'success');
                    await loadData();
                } else {
                    showAlert('Gagal menghapus data: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Terjadi kesalahan saat menghapus data', 'error');
            }
        }

        // Fungsi untuk download Excel
        function downloadExcel() {
            if (filteredData.length === 0) {
                showAlert('Tidak ada data untuk didownload', 'error');
                return;
            }
            
            // Prepare data for Excel
            const excelData = [];
            
            // Add headers (sesuai urutan form: Tanggal, Kelas, Jam Mulai, Jam Selesai, Materi, Status, Tidak Hadir, Catatan)
            excelData.push([
                'No',
                'Tanggal',
                'Kelas',
                'Jam Mulai',
                'Jam Selesai', 
                'Materi',
                'Status',
                'Tidak Hadir',
                'Catatan'
            ]);
            
            // Add data rows (sesuai urutan form)
            filteredData.forEach((item, index) => {
                excelData.push([
                    index + 1,
                    item.tanggal,
                    item.kelas,
                    item.jam_mulai,
                    item.jam_selesai,
                    item.materi,
                    item.status,
                    item.tidak_hadir,
                    item.catatan
                ]);
            });
            
            // Create workbook and worksheet
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(excelData);
            
            // Set column widths (sesuai urutan form)
            const colWidths = [
                { wch: 5 },   // No
                { wch: 12 },  // Tanggal
                { wch: 10 },  // Kelas
                { wch: 10 },  // Jam Mulai
                { wch: 10 },  // Jam Selesai
                { wch: 30 },  // Materi
                { wch: 12 },  // Status
                { wch: 20 },  // Tidak Hadir
                { wch: 25 }   // Catatan
            ];
            worksheet['!cols'] = colWidths;
            
            // Style headers
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4F81BD" } },
                alignment: { horizontal: "center", vertical: "center" }
            };
            
            // Apply header styles
            for (let col = 0; col < excelData[0].length; col++) {
                const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!worksheet[cellRef]) continue;
                worksheet[cellRef].s = headerStyle;
            }
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Jurnal Pembelajaran');
            
            // Generate filename with current date
            const currentDate = new Date().toISOString().split('T')[0];
            const filterKelas = document.getElementById('filterKelas').value;
            const filename = `jurnal_pembelajaran${filterKelas ? '_' + filterKelas.replace(/\s/g, '_') : ''}_${currentDate}.xlsx`;
            
            // Save file
            XLSX.writeFile(workbook, filename);
            
            showAlert('Data Excel berhasil didownload!', 'success');
        }

        // Fungsi untuk download CSV (existing function with improvements)
        function downloadCSV() {
            if (filteredData.length === 0) {
                showAlert('Tidak ada data untuk didownload', 'error');
                return;
            }
            
            // Prepare CSV data (untuk CSV: gabung waktu agar lebih ringkas)
            let csv = 'No,Tanggal,Waktu,Kelas,Materi,Status,Tidak Hadir,Catatan\n';
            
            filteredData.forEach((item, index) => {
                const waktu = item.jam_mulai && item.jam_selesai ? `${item.jam_mulai} - ${item.jam_selesai}` : '-';
                const row = [
                    index + 1,
                    item.tanggal,
                    waktu,
                    item.kelas,
                    item.materi,
                    item.status,
                    item.tidak_hadir,
                    item.catatan
                ];
                csv += row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            const currentDate = new Date().toISOString().split('T')[0];
            const filterKelas = document.getElementById('filterKelas').value;
            const filename = `jurnal_pembelajaran${filterKelas ? '_' + filterKelas.replace(/\s/g, '_') : ''}_${currentDate}.csv`;
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('Data CSV berhasil didownload!', 'success');
        }

        // Fungsi helper
        function getStatusClass(status) {
            const statusMap = {
                'Hadir': 'status-hadir',
                'Tidak Hadir': 'status-tidak-hadir',
                'Sakit': 'status-sakit',
                'Izin': 'status-izin',
                'Selesai': 'status-selesai',
                'Tidak Selesai': 'status-tidak-selesai'
            };
            return statusMap[status] || '';
        }
		
		function formatTime(dateString) {
    	const date = new Date(dateString);
    	return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
		}
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('id-ID', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return dateStr;
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>